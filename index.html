<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Space Factory</title>
<style>
  :root{
    --bg1: #071028;
    --bg2: #021428;
    --accent: #6fb3ff;
    --muted: #9fb5d9;
    --grad-a: linear-gradient(135deg,#071028,#0b1840);
  }
  html,body{height:100%;margin:0;font-family:ui-monospace,monospace;background:var(--bg1);color:#eaf4ff}
  body{transition: background 1s ease}
  header{padding:16px;text-align:center;background:rgba(255,255,255,0.02);border-bottom:1px solid rgba(255,255,255,0.03)}
  h1{margin:0;font-size:clamp(18px,3vw,28px)}
  .muted{color:var(--muted);font-size:13px}
  .wrap{display:flex;gap:14px;padding:14px;flex-wrap:wrap;justify-content:center}
  .panel{background:rgba(255,255,255,0.03);border-radius:10px;padding:12px;width:320px;box-shadow:0 6px 18px rgba(0,0,0,0.6);min-height:140px}
  .wide{width:700px}
  .sectionTitle{font-weight:800;margin:6px 0}
  button{background:linear-gradient(180deg,var(--accent),#4e8fe3);border:0;color:#02112a;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700;margin:6px 0}
  button.small{padding:6px 8px;font-size:13px}
  button:disabled{opacity:0.45;cursor:not-allowed}
  .resource{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .log{height:130px;overflow:auto;background:rgba(255,255,255,0.01);padding:8px;border-radius:6px;font-size:13px}
  .price{color:#dceeff;font-weight:700}
  .smallmuted{font-size:12px;color:var(--muted)}
  .badge{display:inline-block;padding:4px 8px;border-radius:8px;background:rgba(255,255,255,0.03);margin:4px 2px}
  .egg{padding:6px;border-radius:8px;background:rgba(255,255,255,0.02);margin:6px 0}
  .alienCard{padding:6px;border-radius:8px;background:rgba(255,255,255,0.02);margin:6px 0;display:flex;justify-content:space-between}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#081428;padding:18px;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.7);z-index:40;width:80%;max-width:700px}
  .hidden{display:none}
  input[type="text"]{padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);width:190px}
  .brainrot{position:fixed;left:12px;bottom:12px;color:#ffd6d6;font-weight:700;pointer-events:none;z-index:20}
  .asciiBox{font-family:monospace;font-size:12px;line-height:12px;color:#dff3ff;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;pointer-events:none}
  .howto{font-size:14px;line-height:1.4}
  .equipBtn{background:#ffd27d;color:#02112a;border-radius:6px;padding:6px 8px;font-weight:800}
  footer{padding:8px;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>

<header>
  <h1 id="title">üåå Space Factory</h1>
  <div class="muted">Enter username (admin: <code>felipicklejalapeno</code>)</div>
  <div style="margin-top:8px">
    <input id="usernameInput" placeholder="Your name">
    <button class="small" onclick="setUsername()">Set Username</button>
    <button class="small" onclick="openHowTo()">How to Play</button>
  </div>
</header>

<div class="wrap">

  <!-- LEFT: resources & factories -->
  <div class="panel">
    <div class="sectionTitle">Resources</div>
    <div id="resources"></div>

    <div style="margin-top:8px;">
      <button onclick="manualMine()">üíé Mine Ore</button>
      <button onclick="manualEnergy()">‚ö° Generate Energy</button>
    </div>

    <hr>
    <div class="sectionTitle">Factories (auto)</div>
    <div id="factories"></div>
  </div>

  <!-- CENTER: Generators, eggs, aliens -->
  <div class="panel wide">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="sectionTitle">Alien Generators & Eggs</div>
        <div class="smallmuted">Generators produce eggs. Wait until an egg becomes ready then click <strong>HATCH</strong> to get the alien.</div>
      </div>
      <div class="smallmuted">Autosave every 10s</div>
    </div>

    <div style="display:flex;gap:12px;margin-top:8px">
      <div style="flex:1">
        <div class="sectionTitle">Generators</div>
        <div id="generators"></div>
      </div>

      <div style="flex:1">
        <div class="sectionTitle">Eggs (click to hatch when ready)</div>
        <div id="eggs"></div>
      </div>
    </div>

    <hr>
    <div style="display:flex;gap:12px;align-items:flex-start">
      <div style="flex:1">
        <div class="sectionTitle">Collected Aliens</div>
        <div id="collected" class="muted"></div>
      </div>
      <div style="width:260px">
        <div class="sectionTitle">Equip</div>
        <div class="smallmuted">Choose an alien to equip (changes smooth background gradient).</div>
        <div id="equipList"></div>
      </div>
    </div>

    <hr>
    <div class="sectionTitle">Log</div>
    <div id="log" class="log"></div>
  </div>

  <!-- RIGHT: station, achievements, shop -->
  <div class="panel">
    <div class="sectionTitle">Space Station (one-time cosmetic purchases)</div>
    <div id="station"></div>

    <hr>
    <div class="sectionTitle">Achievements</div>
    <div id="achievements" class="muted"></div>

    <hr>
    <div class="sectionTitle">Controls</div>
    <div class="smallmuted">
      <button class="small" onclick="saveNow()">Save Now</button>
      <button class="small" onclick="resetGame()">Reset Save</button>
    </div>
  </div>
</div>

<div id="brainrot" class="brainrot"></div>
<div id="asciiArt" style="position:fixed;right:12px;top:120px"></div>

<!-- How to Play modal -->
<div id="howto" class="modal hidden">
  <h2>How to Play</h2>
  <div class="howto">
    <ol>
      <li>Set your username (special admin username grants powers).</li>
      <li>Mine Ore and Generate Energy manually or build Factories to auto-produce resources.</li>
      <li>Buy and upgrade Alien Generators ‚Äî they produce <strong>eggs</strong>.</li>
      <li>When an egg is <em>ready to hatch</em> you'll see a HATCH button ‚Äî click it to reveal an alien.</li>
      <li>Collected aliens give small bonuses and you can <strong>equip</strong> one to change the smooth background gradient.</li>
      <li>Space Station items are cosmetic single-purchases that add effects (coffee popup, brainrot text, art gallery, etc.).</li>
      <li>Unlock achievements by hatching rare aliens, building factories, and more.</li>
    </ol>
    <p class="smallmuted">Tip: generators scale in price (cost = base * 1.15^level). Higher generator levels increase the chance of rarer aliens.</p>
  </div>
  <div style="margin-top:10px;text-align:right">
    <button onclick="closeHowTo()">Close</button>
  </div>
</div>

<footer>
  Refined text-based play ‚Äî have fun! (Autosaves every 10s)
</footer>

<script>
/* ==========================
   GAME STATE
   ========================== */

const SAVE_KEY = 'space_factory_refined_save_v1';

let state = {
  username: 'Player',
  isAdmin: false,
  resources: {
    ore: 100,
    metal: 20,
    energy: 50,
    crystal: 0,
    alloy: 0,
    circuit: 0,
    fuelCell: 0,
    shipPart: 0,
    aiCore: 0,
    nanofiber: 0,
    quantumGel: 0,
    darkMatter: 0,
    hyperalloy: 0,
    galaxyCoin: 0
  },
  factories: {
    oreFactory: 0,
    energyGen: 0,
    smelter: 0,
    crystalExtractor: 0,
    circuitFoundry: 0,
    alloyForge: 0,
    fuelProcessor: 0,
    nanofiberLoom: 0,
    quantumSynth: 0,
    darkMatterHarvester: 0,
    hyperalloyReactor: 0,
    shipyard: 0,
    galaxyMine: 0
  },
  generators: {
    basicGen: { level: 0, baseCost: { metal: 50, energy: 20 }, baseInterval: 8 },
    advancedGen: { level: 0, baseCost: { metal: 500, alloy: 20, energy: 200 }, baseInterval: 20 },
    exoticGen: { level: 0, baseCost: { alloy: 500, circuit: 50, energy: 500 }, baseInterval: 40 }
  },
  eggs: [], // eggs waiting / ready: {id, genKey, bornAt, readyAt, hatched:false, quality?}
  aliens: [], // collected aliens objects {id,name,rarity,bonus}
  equippedAlienId: null,
  station: {}, // purchases
  achievements: [],
  lastSaved: null
};

/* ==========================
   DATA DEFINITIONS
   ========================== */

const alienPool = [
  { name: 'Glorp', rarity: 'common', bonus: { ore: 1 }, colorA: '#6f3cff', colorB: '#1a0f3b' },
  { name: 'Vunxi', rarity: 'uncommon', bonus: { crystal: 0.8 }, colorA: '#0fffd3', colorB: '#012a2a' },
  { name: 'Xyroth', rarity: 'rare', bonus: { alloy: 0.5 }, colorA: '#ffd27d', colorB: '#3a2b00' },
  { name: 'Quarnax', rarity: 'epic', bonus: { darkMatter: 0.05 }, colorA: '#9d4cff', colorB: '#10002b' },
  { name: 'Omnicron Prime', rarity: 'legendary', bonus: { hyperalloy: 0.2 }, colorA: '#00ffd5', colorB: '#ff00b7' }
];

// factory definitions (costs & produce)
const factoriesDef = {
  oreFactory: { name:'Ore Factory', cost:{ore:20}, produce:{ore:1} },
  energyGen: { name:'Energy Generator', cost:{ore:10}, produce:{energy:1} },
  smelter: { name:'Smelter', cost:{ore:50,energy:10}, consume:{ore:3}, produce:{metal:1} },
  crystalExtractor: { name:'Crystal Extractor', cost:{ore:120,metal:40}, produce:{crystal:0.25} },
  circuitFoundry: { name:'Circuit Foundry', cost:{metal:200,crystal:50,energy:40}, consume:{metal:1,crystal:1}, produce:{circuit:1} },
  alloyForge: { name:'Alloy Forge', cost:{metal:150,energy:60}, consume:{metal:4}, produce:{alloy:1} },
  fuelProcessor: { name:'Fuel Processor', cost:{ore:100,energy:80}, consume:{ore:3,energy:2}, produce:{fuelCell:1} },
  nanofiberLoom: { name:'Nanofiber Loom', cost:{alloy:1000,circuit:500,crystal:200}, consume:{alloy:5,circuit:2,crystal:1}, produce:{nanofiber:1} },
  quantumSynth: { name:'Quantum Synthesizer', cost:{fuelCell:3000,metal:5000,crystal:2000}, consume:{fuelCell:3,metal:5,crystal:1}, produce:{quantumGel:1} },
  darkMatterHarvester: { name:'Dark Matter Harvester', cost:{energy:1000000,metal:200000,aiCore:50000}, consume:{energy:2000}, produce:{darkMatter:1} },
  hyperalloyReactor: { name:'Hyperalloy Reactor', cost:{nanofiber:2000,quantumGel:1000,alloy:2000}, consume:{nanofiber:2,quantumGel:1,alloy:1}, produce:{hyperalloy:1} },
  shipyard: { name:'Shipyard', cost:{metal:5000,alloy:2000,energy:1000}, consume:{metal:20,alloy:5,energy:50}, produce:{shipPart:1} },
  galaxyMine: { name:'Galaxy Mine', cost:{darkMatter:10,energy:5000}, consume:{energy:500}, produce:{galaxyCoin:1} }
};

// Station items (one-time) ‚Äî Roblox cost made more affordable here
const stationItems = {
  coffeeMachine: { name:'Coffee Machine', cost:{metal:50,energy:20}, desc:'Every 10 minutes: "Your coffee is ready".' },
  gym: { name:'Gym', cost:{metal:200,energy:50,circuit:10}, desc:'Small passive energy multiplier.' },
  retroArcade: { name:'Retro Arcade', cost:{metal:500,circuit:50}, desc:'Adds retro background vibe.' },
  hydroGarden: { name:'Hydroponic Garden', cost:{metal:300,crystal:10}, desc:'Pretty plants.' },
  robloxExperience: { name:'ROBLOX EXPERIENCE‚Ñ¢', cost:{hyperalloy:50000,darkMatter:1,circuit:5000,aiCore:10}, desc:'Brainrot phrases in background every 5s.' }, // MUCH cheaper than before
  artGallery: { name:'Art Gallery', cost:{metal:250,crystal:20}, desc:'Shows ascii art every 60s.' },
  observatory: { name:'Observatory', cost:{metal:600,crystal:100}, desc:'Chance to find rare materials occasionally.' },
  lab: { name:'Science Lounge', cost:{metal:800,crystal:200,energy:300}, desc:'Small global production multiplier.' }
};

/* ==========================
   UTILS
   ========================== */

function format(n){
  if(n>=1e9) return (n/1e9).toFixed(2)+'B';
  if(n>=1e6) return (n/1e6).toFixed(2)+'M';
  if(n>=1000) return (n/1000).toFixed(1)+'k';
  return Math.round(n*100)/100;
}

function canAfford(cost){
  for(const k in cost){
    if((state.resources[k] || 0) < cost[k]) return false;
  }
  return true;
}

function payCost(cost){
  for(const k in cost){
    state.resources[k] = Math.max(0, (state.resources[k] || 0) - cost[k]);
  }
}

function scaledCost(base, level){
  const out = {};
  for(const k in base){
    out[k] = Math.ceil(base[k] * Math.pow(1.15, level));
  }
  return out;
}

function randId(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }

function log(msg){
  const el = document.getElementById('log');
  const time = new Date().toLocaleTimeString();
  el.innerHTML = `<div>[${time}] ${msg}</div>` + el.innerHTML;
}

/* ==========================
   RENDER FUNCTIONS
   ========================== */

function renderResources(){
  const container = document.getElementById('resources');
  container.innerHTML = '';
  for(const k in state.resources){
    const v = state.resources[k];
    const div = document.createElement('div'); div.className = 'resource';
    div.innerHTML = `<div>${k}</div><div>${format(v)}</div>`;
    container.appendChild(div);
  }
}

function renderFactories(){
  const container = document.getElementById('factories');
  container.innerHTML = '';
  for(const k in factoriesDef){
    const def = factoriesDef[k];
    const count = state.factories[k] || 0;
    const costText = Object.entries(def.cost).map(e=>`${e[1]} ${e[0]}`).join(' / ');
    const card = document.createElement('div');
    card.innerHTML = `<div style="font-weight:800">${def.name} x${count}</div>
      <div class="smallmuted">Cost: <span class="price">${costText}</span></div>
      <button class="small" onclick="buyFactory('${k}')">Buy ${def.name}</button>`;
    container.appendChild(card);
  }
}

function renderGenerators(){
  const container = document.getElementById('generators');
  container.innerHTML = '';
  for(const key in state.generators){
    const g = state.generators[key];
    const cost = scaledCost(g.baseCost, g.level);
    const costText = Object.entries(cost).map(e=>`${e[1]} ${e[0]}`).join(' / ') || '‚Äî';
    const speed = Math.max(0.5, (g.baseInterval / Math.max(1,g.level)));
    const div = document.createElement('div');
    div.innerHTML = `<div style="font-weight:800">${prettyGenName(key)} (Level ${g.level})</div>
      <div class="smallmuted">Upgrade cost: <span class="price">${costText}</span></div>
      <div class="smallmuted">Effective egg interval (approx): ${speed}s</div>
      <div style="margin-top:6px"><button onclick="upgradeGenerator('${key}')">Upgrade ${prettyGenName(key)}</button></div>`;
    container.appendChild(div);
  }
}

function prettyGenName(key){
  if(key==='basicGen') return 'Basic Alien Generator';
  if(key==='advancedGen') return 'Advanced Alien Generator';
  if(key==='exoticGen') return 'Exotic Alien Generator';
  return key;
}

function renderEggs(){
  const container = document.getElementById('eggs');
  container.innerHTML = '';
  if(state.eggs.length === 0){ container.innerHTML = '<div class="smallmuted">No eggs yet</div>'; return; }
  // show eggs sorted by readyAt
  const eggs = state.eggs.slice().sort((a,b)=>a.readyAt - b.readyAt);
  eggs.forEach(egg => {
    const div = document.createElement('div');
    div.className = 'egg';
    const ready = Date.now() >= egg.readyAt;
    const genPretty = prettyGenName(egg.genKey);
    div.innerHTML = `<div><strong>Egg</strong> (${genPretty}) - ${ready?'<span style="color:#7cffb2">Ready to Hatch</span>':'Not ready'}</div>
      <div class="smallmuted">Produced: ${new Date(egg.bornAt).toLocaleTimeString()}</div>
      <div style="margin-top:6px">${ready?`<button onclick="hatchEgg('${egg.id}')">HATCH</button>`:`<small class="smallmuted">Ready in ${Math.ceil((egg.readyAt - Date.now())/1000)}s</small>`}</div>`;
    container.appendChild(div);
  });
}

function renderCollected(){
  const container = document.getElementById('collected');
  container.innerHTML = '';
  if(state.aliens.length === 0) { container.innerHTML = '<div class="smallmuted">None yet</div>'; return; }
  state.aliens.slice().reverse().forEach(al => {
    const div = document.createElement('div');
    div.className = 'alienCard';
    div.innerHTML = `<div>
        <div style="font-weight:800">${al.name} <span class="smallmuted">(${al.rarity})</span></div>
        <div class="smallmuted">bonus: ${Object.entries(al.bonus).map(e=>`${e[1]} ${e[0]}`).join(', ')}</div>
      </div>
      <div style="text-align:right">
        <div class="smallmuted">id:${al.id.slice(-6)}</div>
        <div style="margin-top:6px"><button class="equipBtn" onclick="equipAlien('${al.id}')">${state.equippedAlienId===al.id? 'Equipped':'Equip'}</button></div>
      </div>`;
    container.appendChild(div);
  });
  renderEquipList();
}

function renderEquipList(){
  const container = document.getElementById('equipList');
  container.innerHTML = '';
  if(state.aliens.length === 0){ container.innerHTML = '<div class="smallmuted">No aliens to equip</div>'; return; }
  state.aliens.forEach(al=>{
    const btn = document.createElement('button');
    btn.className = 'small';
    btn.style.display = 'block';
    btn.style.marginBottom = '6px';
    btn.textContent = `${al.name} (${al.rarity})`;
    btn.onclick = ()=> equipAlien(al.id);
    container.appendChild(btn);
  });
}

function renderStation(){
  const container = document.getElementById('station');
  container.innerHTML = '';
  for(const k in stationItems){
    const itm = stationItems[k];
    const bought = !!state.station[k];
    const costText = Object.entries(itm.cost).map(e=>`${e[1]} ${e[0]}`).join(' / ');
    const div = document.createElement('div');
    div.innerHTML = `<div style="font-weight:800">${itm.name} ${bought?'<span class="smallmuted">[BOUGHT]</span>':''}</div>
      <div class="smallmuted">${itm.desc}</div>
      <div class="smallmuted">Cost: <span class="price">${costText}</span></div>
      <div style="margin-top:6px"><button onclick="buyStation('${k}')" ${bought? 'disabled':''}>${bought? 'Purchased':'Buy'}</button></div>`;
    container.appendChild(div);
  }
}

function renderAchievements(){
  const el = document.getElementById('achievements');
  el.innerHTML = '';
  if(state.achievements.length === 0) el.innerHTML = '<div class="smallmuted">No achievements yet</div>';
  state.achievements.forEach(a => {
    el.innerHTML += `<div>üèÜ ${a}</div>`;
  });
}

/* ==========================
   GAME ACTIONS: buy, upgrade, hatch
   ========================== */

function buyFactory(key){
  const def = factoriesDef[key];
  if(!def) return;
  if(!canAfford(def.cost)){ alert('Not enough resources'); return; }
  payCost(def.cost);
  state.factories[key] = (state.factories[key]||0) + 1;
  log(`Built ${def.name} (total ${state.factories[key]})`);
  renderResources(); renderFactories();
  checkAchievements();
}

function upgradeGenerator(key){
  const gen = state.generators[key];
  const cost = scaledCost(gen.baseCost, gen.level);
  if(!canAfford(cost)){ alert('Not enough resources'); return; }
  payCost(cost);
  gen.level += 1;
  log(`Upgraded ${prettyGenName(key)} to level ${gen.level}`);
  renderGenerators(); renderResources();
  checkAchievements();
}

function buyStation(key){
  if(state.station[key]) return;
  const itm = stationItems[key];
  if(!canAfford(itm.cost)){ alert('Cannot afford this'); return; }
  payCost(itm.cost);
  state.station[key] = true;
  log(`Purchased station item: ${itm.name}`);
  applyStationEffect(key);
  renderStation();
  renderResources();
  checkAchievements();
}

/* generators produce eggs (not direct aliens) */
function generatorProduce(genKey){
  const gen = state.generators[genKey];
  if(!gen || gen.level <= 0) return;
  // compute effective interval = baseInterval / level
  const interval = Math.max(1, gen.baseInterval / gen.level);
  // produce with probability per second
  const prob = 1 / interval;
  if(Math.random() < prob){
    // create an egg
    const now = Date.now();
    // ready delay depends on generator type: exotic eggs take longer to hatch but have higher rarity
    const hatchDelay = Math.max(3, Math.round(interval * (0.5 + Math.random()))); // seconds
    const egg = { id: randId('egg'), genKey, bornAt: now, readyAt: now + hatchDelay*1000, hatched:false };
    state.eggs.push(egg);
    log(`An egg was produced by ${prettyGenName(genKey)} (ready in ${hatchDelay}s)`);
    renderEggs();
  }
}

function hatchEgg(eggId){
  const idx = state.eggs.findIndex(e=>e.id===eggId);
  if(idx===-1) return;
  const egg = state.eggs[idx];
  if(Date.now() < egg.readyAt){ alert('Egg not ready yet'); return; }
  // determine alien based on generator level and type
  const gen = state.generators[egg.genKey];
  const alienTemplate = pickAlienByGenerator(gen.level, egg.genKey);
  // create collected alien instance (apply small variation)
  const alien = {
    id: randId('ali'),
    name: alienTemplate.name,
    rarity: alienTemplate.rarity,
    bonus: alienTemplate.bonus,
    colorA: alienTemplate.colorA,
    colorB: alienTemplate.colorB
  };
  state.aliens.push(alien);
  state.aliensCollected = (state.aliensCollected || 0) + 1; // legacy
  // apply bonus immediately
  for(const r in alien.bonus) state.resources[r] = (state.resources[r]||0) + alien.bonus[r];
  // remove egg
  state.eggs.splice(idx,1);
  log(`Hatched an alien: ${alien.name} (${alien.rarity})`);
  // add to achievements
  if(alien.rarity === 'rare' && !state.achievements.includes('Hatched a Rare')) { state.achievements.push('Hatched a Rare'); alert('Achievement: Hatched a Rare!'); }
  if(alien.rarity === 'epic' && !state.achievements.includes('Hatched an Epic')) { state.achievements.push('Hatched an Epic'); alert('Achievement: Hatched an Epic!'); }
  if(alien.rarity === 'legendary' && !state.achievements.includes('Hatched a Legendary')) { state.achievements.push('Hatched a Legendary'); alert('Achievement: Hatched a Legendary!'); }
  if(state.aliens.length >= 1 && !state.achievements.includes('First Alien Hatched')) { state.achievements.push('First Alien Hatched'); }
  renderEggs(); renderCollected(); renderAchievements(); renderResources();
}

/* pick alien by generator type and level (rarity distribution) */
function makeRarityProb(level, genKey){
  let base;
  if(genKey==='basicGen') base = [0.8,0.15,0.04,0.01,0.0];
  else if(genKey==='advancedGen') base = [0.6,0.27,0.08,0.04,0.01];
  else base = [0.45,0.30,0.15,0.07,0.03];
  // shift by level
  const shift = Math.min(level * 0.006, 0.25);
  let probs = base.slice();
  for(let i=0;i<probs.length-1;i++){
    const move = probs[i]*shift;
    probs[i] -= move;
    probs[i+1] += move;
  }
  const s = probs.reduce((a,b)=>a+b,0);
  return probs.map(p=>p/s);
}
function pickAlienByGenerator(level, genKey){
  const probs = makeRarityProb(level, genKey);
  const r = Math.random(); let cum=0;
  for(let i=0;i<probs.length;i++){ cum+=probs[i]; if(r<=cum) return alienPool[i]; }
  return alienPool[0];
}

/* equipping alien changes background smooth gradient */
function equipAlien(alId){
  const al = state.aliens.find(a=>a.id===alId);
  if(!al) return;
  state.equippedAlienId = al.id;
  // change background gradient using colors
  document.body.style.background = `linear-gradient(120deg, ${al.colorA}, ${al.colorB})`;
  log(`Equipped alien: ${al.name} ‚Äî background changed.`);
  renderCollected(); renderEquipList();
  // achievement for equipping
  if(!state.achievements.includes('Equipped an Alien')){ state.achievements.push('Equipped an Alien'); renderAchievements(); alert('Achievement: Equipped an Alien'); }
}

/* station effects application */
let brainrotInterval = null;
let asciiInterval = null;
let coffeeInterval = null;
let observatoryInterval = null;

function applyStationEffect(key){
  if(key==='coffeeMachine'){
    if(coffeeInterval) clearInterval(coffeeInterval);
    coffeeInterval = setInterval(()=>{ alert('‚òï Your coffee is ready!'); log('Coffee ready popup'); }, 10*60*1000); // 10 min
  }
  if(key==='robloxExperience'){
    if(brainrotInterval) clearInterval(brainrotInterval);
    const phrases = ['get rizzed üíÄ','Ohio level sigma','Skibidi Ohio','rizzcore','based brainrot','cosmic cringe','oof intensifies'];
    brainrotInterval = setInterval(()=>{ document.getElementById('brainrot').innerText = phrases[Math.floor(Math.random()*phrases.length)]; }, 5000);
  }
  if(key==='artGallery'){
    if(asciiInterval) clearInterval(asciiInterval);
    const arts = [
`  .-"""-.
 (  . .  )
  \\  ^  /
   '---'`,
` /\\_/\\
( o.o )
 > ^ <`,
`  _==_
 /    \\
| o  o |
 \\_--_/`
    ];
    asciiInterval = setInterval(()=>{ document.getElementById('asciiArt').innerHTML = '<div class="asciiBox">' + arts[Math.floor(Math.random()*arts.length)] + '</div>'; }, 60000);
  }
  if(key==='observatory'){
    if(observatoryInterval) clearInterval(observatoryInterval);
    observatoryInterval = setInterval(()=>{
      if(Math.random() < 0.15){
        const found = 'crystal';
        state.resources[found] = (state.resources[found] || 0) + 5;
        log('Observatory found 5 crystal!');
        renderResources();
      }
    }, 60*1000);
  }
  if(key==='gym'){
    // small energy boost via multiplier
    state.upgradeGym = true;
  }
  if(key==='lab'){
    state.upgrades.factoryBoost = (state.upgrades.factoryBoost || 0) + 0.05;
    log('Science Lounge increases factory production by 5%');
  }
}

/* ==========================
   ACHIEVEMENTS CHECK
   ========================== */

function checkAchievements(){
  if(state.aliens.length >= 5 && !state.achievements.includes('Own 5 Aliens')){ state.achievements.push('Own 5 Aliens'); log('Achievement: Own 5 Aliens'); alert('Achievement unlocked: Own 5 Aliens'); }
  if(state.factories.shipyard >= 1 && !state.achievements.includes('Built a Spaceship')){ state.achievements.push('Built a Spaceship'); log('Achievement: Built a Spaceship'); alert('Achievement unlocked: Built a Spaceship'); }
  if(state.generators.basicGen.level >= 1 && !state.achievements.includes('Bought Basic Generator')){ state.achievements.push('Bought Basic Generator'); }
  if(state.generators.advancedGen.level >= 1 && !state.achievements.includes('Bought Advanced Generator')){ state.achievements.push('Bought Advanced Generator'); }
  if(state.generators.exoticGen.level >= 1 && !state.achievements.includes('Bought Exotic Generator')){ state.achievements.push('Bought Exotic Generator'); }
  // others handled at events
  renderAchievements();
}

/* ==========================
   PRODUCTION LOOPS
   ========================== */

function factoryTick(){
  for(const k in factoriesDef){
    const f = factoriesDef[k];
    const count = state.factories[k] || 0;
    if(count <= 0) continue;
    // check consumption if any
    let canRun = true;
    if(f.consume){
      for(const r in f.consume) if((state.resources[r]||0) < f.consume[r]*count) { canRun = false; break; }
    }
    if(!canRun) continue;
    if(f.consume) for(const r in f.consume) state.resources[r] -= f.consume[r]*count;
    if(f.produce) for(const r in f.produce) {
      let base = f.produce[r]*count;
      // gym effect: small extra energy
      if(r==='energy' && state.station.gym) base *= 1.05;
      // apply factory boost
      base *= (1 + (state.upgrades.factoryBoost || 0));
      state.resources[r] = (state.resources[r]||0) + base;
    }
  }
  // render
  renderResources();
}

function generatorTickAll(){
  for(const gk in state.generators) generatorProduce(gk);
}

/* egg readiness update UI */
function eggTick(){
  // remove eggs older than some huge time? keep them
  renderEggs();
}

/* timers */
setInterval(()=>{ factoryTick(); checkAchievements(); saveIfNeeded(); }, 1000);
setInterval(()=>{ generatorTickAll(); eggTick(); }, 1000);

/* ==========================
   MANUAL ACTIONS
   ========================== */

function manualMine(){ state.resources.ore = (state.resources.ore||0) + 1; log('You mined 1 ore'); renderResources(); }
function manualEnergy(){ state.resources.energy = (state.resources.energy||0) + 1; log('You generated 1 energy'); renderResources(); }

/* ==========================
   SAVE / LOAD / RESET
   ========================== */

function save(){
  state.lastSaved = Date.now();
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
}

function saveIfNeeded(){ save(); log('Game autosaved'); }

function load(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw) return;
  try{
    const obj = JSON.parse(raw);
    // merge keys carefully (simple approach)
    state = Object.assign(state, obj);
    // ensure arrays exist
    state.eggs = state.eggs || [];
    state.aliens = state.aliens || [];
    state.station = state.station || {};
    state.achievements = state.achievements || [];
    if(state.equippedAlienId){
      const al = state.aliens.find(a=>a.id===state.equippedAlienId);
      if(al) document.body.style.background = `linear-gradient(120deg, ${al.colorA}, ${al.colorB})`;
    }
  } catch(e){ console.warn('Load failed', e); }
}

function saveNow(){ save(); alert('Saved'); }

function resetGame(){
  if(!confirm('Reset game? This clears your save.')) return;
  localStorage.removeItem(SAVE_KEY);
  location.reload();
}

/* ==========================
   USERNAME & ADMIN
   ========================== */

function setUsername(){
  const input = document.getElementById('usernameInput').value.trim();
  if(!input){ alert('Enter a username'); return; }
  state.username = input;
  document.title = `${input}'s Space Factory`;
  document.getElementById('title').innerText = `${input}'s Space Factory`;
  log(`Username set: ${input}`);
  if(input.toLowerCase() === 'felipicklejalapeno'){
    // admin powers
    state.isAdmin = true;
    // grant massive resources
    for(const k in state.resources) if(typeof state.resources[k] === 'number') state.resources[k] = Math.max(state.resources[k], 9999999);
    // set factories
    for(const f in factoriesDef) state.factories[f] = Math.max(state.factories[f]||0, 5);
    // give generator levels
    for(const g in state.generators) state.generators[g].level = Math.max(state.generators[g].level||0, 5);
    // buy all station items
    for(const s in stationItems) state.station[s] = true;
    applyAllStationEffects();
    log('ADMIN: Granted resources, factories, generators, station items.');
    alert('‚ö° Admin Mode Activated! ‚ö°');
    // spawn an admin legendary
    const adminLegend = { id:randId('a'), name:'Omnicron Prime (Admin)', rarity:'legendary', bonus:{hyperalloy:50}, colorA:'#00ffd5', colorB:'#ff00b7' };
    state.aliens.push(adminLegend);
    state.equippedAlienId = adminLegend.id;
    document.body.style.background = `linear-gradient(120deg, ${adminLegend.colorA}, ${adminLegend.colorB})`;
  }
  renderAll();
}

/* apply all station effects (used for load/admin) */
function applyAllStationEffects(){
  for(const k in state.station) if(state.station[k]) applyStationEffect(k);
}

/* ==========================
   INIT & RENDER LOOP
   ========================== */

function renderAll(){
  renderResources();
  renderFactories();
  renderGenerators();
  renderEggs();
  renderCollected();
  renderStation();
  renderAchievements();
}
load();
renderAll();

// start autosave loop
setInterval(()=>{ save(); }, 10000);

/* ==========================
   Misc helpers for UI events
   ========================== */

function openHowTo(){ document.getElementById('howto').classList.remove('hidden'); }
function closeHowTo(){ document.getElementById('howto').classList.add('hidden'); }

/* expose some functions needed in HTML onclicks (if any) */
window.buyFactory = buyFactory;
window.upgradeGenerator = upgradeGenerator;
window.buyStation = buyStation;
window.hatchEgg = hatchEgg;
window.equipAlien = equipAlien;

/* ==========================
   Initial notes log
   ========================== */
log('Game ready. Set username and start building!');

</script>
</body>
</html>
